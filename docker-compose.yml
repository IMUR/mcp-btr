version: "3.8"

services:
  # =============================================================================
  # BTR Gateway - Main MCP aggregation service
  # =============================================================================
  gateway:
    build: ./gateway
    container_name: btr-gateway
    ports:
      - "${BTR_GATEWAY_PORT:-8090}:8090"
    environment:
      - BTR_HOST=0.0.0.0
      - BTR_PORT=8090
      - BTR_DEFAULT_PRESET=${BTR_DEFAULT_PRESET:-development}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./presets:/app/presets:ro
      - ./servers:/app/servers:ro
      - btr-data:/app/data
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - btr-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # =============================================================================
  # BTR Tool Selector UI
  # =============================================================================
  ui:
    build: ./ui
    container_name: btr-ui
    ports:
      - "${BTR_UI_PORT:-5010}:5010"
    environment:
      - BTR_GATEWAY_URL=http://gateway:8090
      - BTR_UI_PORT=5010
    depends_on:
      - gateway
    networks:
      - btr-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5010/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # =============================================================================
  # MCP Server: GitHub
  # =============================================================================
  github-mcp:
    image: ghcr.io/github/github-mcp-server:latest
    container_name: github-mcp
    environment:
      - GITHUB_PERSONAL_ACCESS_TOKEN=${GITHUB_TOKEN}
    networks:
      - btr-network
    restart: unless-stopped

  # =============================================================================
  # MCP Server: Perplexity
  # Note: You may need to build this from source or use a different image
  # =============================================================================
  # perplexity-mcp:
  #   build: ./servers/perplexity
  #   container_name: perplexity-mcp
  #   environment:
  #     - PERPLEXITY_API_KEY=${PERPLEXITY_API_KEY}
  #   networks:
  #     - btr-network
  #   restart: unless-stopped

networks:
  btr-network:
    driver: bridge

volumes:
  btr-data:
    driver: local
